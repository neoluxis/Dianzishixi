C51 COMPILER V9.60.7.0   MAIN                                                              04/03/2024 09:12:30 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          //-----------------------------------------------------------------------------//
   2          //---------------心率仪C51程序框架---by tjx------------------------------------//
   3          //---------------------2022.12-------------------------------------------------//
   4          //------------------crystal=6MHz-----------------------------------------------//
   5          //-----------------------------------------------------------------------------//
   6          
   7          //-----------------------------------------------------------------------------//
   8          // 包含头文件、定义各个接口-----------------------------------------------------//
   9          //-----------------------------------------------------------------------------//
  10          #include <AT89X52.H>
  11          #define uint unsigned int   // 定义一下方便编程
  12          #define uchar unsigned char // 定义一下方便编程
  13          #define keystart P1_0       // 定义心率测量启动按键输入口------不按输入为1电平，按
             -输入为0电平
  14          #define ledtest P3_4        // 定义测量指示灯控制口------------输出1电平灯不亮，输出0
             -平灯亮
  15          #define signal P2_0         // 定义心跳信号输入口--------------根据心跳信号电平高低变
             -
  16          #define keymodel P1_3       // 定义测量模式设置按键输入口------按下输入0电平，松开
             -入1电平
  17          #define ledmodle P1_7       // 定义工作模式指示灯控制口--------输出1电平灯不亮，输出
             -0电平灯亮，用来指示测量模式
  18          #define baiwei P2_1         // 定义百位驱动口------------------百位数码管输出控制端，输
             -出0电平对应的百位点亮，输出1电平对应的百位不亮
  19          #define shiwei P2_4         // 定义十位驱动口------------------十位数码管输出控制端，输
             -出0电平对应的十位点亮，输出1电平对应的十位不亮
  20          #define gewei P2_7          // 定义个位驱动口------------------个位数码管输出控制端，输
             -出0电平对应的个位点亮，输出1电平对应的个位不亮
  21          
  22          #define SOUND_RESET P1_6 // 定义语音芯片复位口
  23          #define SOUND_DATA P1_5  // 定义语音芯片数据口
  24          #define SOUND_BUSY P1_4  // 定义语音芯片忙碌口
  25          void sound_reset(void);
  26          void speek(unsigned char num);
  27          void speekone(void);
  28          code uchar datab[] = {
  29          
  30              0xA0, //"0"
  31              0xAF, //"1"
  32              0x98, //"2"
  33              0x8A, //"3"
  34              0x87, //"4"
  35              0xC2, //"5"
  36              0xC0, //"6"
  37              0xAE, //"7"
  38              0x80, //"8"
  39              0x82, //"9"
  40              0x84, //"A"
  41              0xC1, //"B"
  42              0xF0, //"C"
  43              0x89, //"D"
  44              0xD0, //"E"
  45              0xD4, //"F"
  46              0x85, //"H"
  47              0xF1, //"L"
C51 COMPILER V9.60.7.0   MAIN                                                              04/03/2024 09:12:30 PAGE 2   

  48              0xA4, //"n"
  49              0xA1, //"u"
  50              0x94, //"P"
  51              0xC9, //"o"
  52              0xDF, //"-"
  53              0xFF, //??
  54              0xFF  //???
  55          
  56          };
  57          
  58          code uchar my_xuehao[10] = {2, 2, 0, 1, 4, 0, 0, 2, 1, 6};
  59          
  60          uint heartrate = 0; // 定义心率值存储变量
  61          uchar ge, shi, bai; // 定义心率计数三个位的显示值
  62          uint i = 0;         // 定义全局变量，用于定时计数
  63          uint time = 600;    // 定义计时时间，600次计时为1分钟
  64          bit flag = 0;       // 定义时间标志位变量
  65          bit fast = 0;       // 定义快速测量标志位变量
  66          bit finish = 0;     // 定义测量完成标志位变量
  67          
  68          uchar display_period = 5; // 一个显示周期的时间长度，单位为ms，5ms=5000us，与实习报
             -所测得的一致
  69          
  70          //-----------------------------------------------------------------------------//
  71          // 函数声明---------------------------------------------------------------------//
  72          //-----------------------------------------------------------------------------//
  73          void mcuint(void);         // 单片机初始化函数
  74          void delay1ms(uint count); // 毫秒级延时函数
  75          void measure(int);         // 心率测量函数   快速测量心率的函数自行考虑
  76          int j = 0;
  77          
  78          void display_sound(void);
  79          void display_id(void)
  80          {
  81   1        if (j >= 3)
  82   1        {
  83   2          heartrate = heartrate % 100;
  84   2        }
  85   1        heartrate = my_xuehao[j] + heartrate * 10;
  86   1        speek(my_xuehao[j]);
  87   1        j++;
  88   1        delay1ms(100);
  89   1      }
  90          
  91          void tell_rate(void)
  92          {
  93   1        uint rate[3];
  94   1        uint hrate = heartrate;
  95   1        for (j = 0; hrate; j++, hrate /= 10)
  96   1        {
  97   2          rate[j] = hrate % 10;
  98   2        }
  99   1        for (j=2;j>=0;j--){
 100   2          speek(rate[j]);
 101   2        }
 102   1      }
 103          
 104          //-----------------------------------------------------------------------------//
 105          // 主函数，开机初始化单片机，并显示2s的888，用于检测笔画是否接正确-----------
             ----//
 106          //-----------------------------------------------------------------------------//
 107          void main(void)
C51 COMPILER V9.60.7.0   MAIN                                                              04/03/2024 09:12:30 PAGE 3   

 108          {
 109   1        mcuint();
 110   1        display_sound();
 111   1        heartrate = 000;
 112   1        while (1)
 113   1        {
 114   2          if (keymodel == 0) // 如果按下了测量模式设置按键
 115   2          {
 116   3            fast = ~fast;
 117   3            while (keymodel == 0)
 118   3              ; // 等待按键松开
 119   3          }
 120   2          measure(fast);
 121   2        }
 122   1      }
 123          
 124          //-----------------------------------------------------------------------------//
 125          // 单片机初始化函数-------------------------------------------------------------//
 126          //-----------------------------------------------------------------------------//
 127          void mcuint(void)
 128          {
 129   1        P0 = 0xFF;                                  // 使单片机上电后P0口都输出1
 130   1        P1 = 0xFF;                                  // 使单片机上电后P1口都输出1
 131   1        P2 = 0xFF;                                  // 使单片机上电后P2口都输出1
 132   1        P3 = 0xFF;                                  // 使单片机上电后P3口都输出1
 133   1        TMOD = 0x11;                                // 设定定时器T0、T1的工作模式为16位定时器
 134   1        TL0 = (65536 - display_period * 500) % 256; // 设定定时器T0的低8位初值---T0用于刷新数码
             -显示
 135   1        TH0 = (65536 - display_period * 500) / 256; // 设定定时器T0的高8位初值---T0用于刷新数码
             -显示
 136   1        TL1 = (65536 - 100 * 500) % 256;            // 设定定时器T1的低8位初值---100为100毫秒，1
             -计时100毫秒，600次就是1分钟
 137   1        TH1 = (65536 - 100 * 500) / 256;            // 设定定时器T1的高8位初值
 138   1        IE = 0x8A;                                  // 开总中断、定时器T0中断、定时器T1中断
 139   1        IP = 0x08;                                  // 设定中断优先级，定时器T1中断优先
 140   1        TR0 = 1;                                    // 开启定时器T0，数码管开始定时刷新显示
 141   1      }
 142          
 143          //-----------------------------------------------------------------------------//
 144          // 延时1ms的函数----------------------------------------------------------------//
 145          //-----------------------------------------------------------------------------//
 146          void delay1ms(uint count)
 147          {
 148   1        int m, n;
 149   1        for (m = 0; m < count; m++)
 150   1          for (n = 0; n < 59; n++)
 151   1            ;
 152   1      }
 153          
 154          //-----------------------------------------------------------------------------//
 155          // T0中断服务函数，作用是每5ms扫描一次数码管------------------------------------//
 156          //-----------------------------------------------------------------------------//
 157          void timer0() interrupt 1
 158          {
 159   1        TL0 = 0x3C;
 160   1        TH0 = 0xF6;
 161   1        // 假设每分钟跳135次  ,heartrate=321
 162   1        bai = heartrate / 100;       // 计算百位数值
 163   1        shi = (heartrate / 10) % 10; // 计算十位数值
 164   1        ge = heartrate % 10;         // 计算个位数值
 165   1      
 166   1        // 以下三个语句为显示个位的数值
C51 COMPILER V9.60.7.0   MAIN                                                              04/03/2024 09:12:30 PAGE 4   

 167   1        P0 = datab[ge]; // 把各位显示数值的码值取出来给P0
 168   1        gewei = 0;      // P2_7=0; 相当于开启个位的电源
 169   1        delay1ms(1);
 170   1        gewei = 1; // P2_7=1; 相当于关闭个位的电源
 171   1      
 172   1        // 以下三个语句为显示十位的数值
 173   1        P0 = datab[shi]; // 把十位显示数值的码值取出来给P0
 174   1        shiwei = 0;      // P2_4=0; 相当于开启十位的电源
 175   1        delay1ms(1);
 176   1        shiwei = 1; // P2_4=1; 相当于关闭十位的电源
 177   1      
 178   1        // 以下三个语句为显示百位的数值
 179   1        P0 = datab[bai]; // 把百位显示数值的码值取出来给P0
 180   1        baiwei = 0;      // P2_1=0; 相当于开启百位的电源
 181   1        delay1ms(1);
 182   1        baiwei = 1; // P2_1=1; 相当于关闭百位的电源
 183   1      }
 184          
 185          //-----------------------------------------------------------------------------//
 186          // T1中断函数，作用是1分钟计时，时间到置标志位为1------------------------------//
 187          //-----------------------------------------------------------------------------//
 188          void timer1() interrupt 3
 189          {
 190   1        TL1 = 0xB0;
 191   1        TH1 = 0x3C;
 192   1        i++;
 193   1        if (i == time) // 如果计时时间到了，标志位置1
 194   1        {
 195   2          i = 0;    // 计数变量归0
 196   2          flag = 1; // 时间到标志位置1
 197   2        }
 198   1        if (finish)
 199   1        {
 200   2          if (i % 10 == 0)
 201   2            ledtest = !ledtest;
 202   2        }
 203   1      }
 204          
 205          //-----------------------------------------------------------------------------//
 206          // 慢速测量心率函数-------------------------------------------------------------//
 207          //-----------------------------------------------------------------------------//
 208          void measure(int mod)
 209          {
 210   1        if (mod)
 211   1        {
 212   2          ledmodle = 0;
 213   2          time = 40;
 214   2        }
 215   1        else
 216   1        {
 217   2          ledmodle = 1;
 218   2          time = 600;
 219   2        }
 220   1        if (keystart == 0)
 221   1        {
 222   2          finish = 0;    // 测量完成标志位清0
 223   2          heartrate = 0; // 心率值清0
 224   2          TR1 = 1;       // 开启定时器，开始60秒计时
 225   2          ledtest = 0;   // 点亮测量指示灯
 226   2          while (1)
 227   2          {
 228   3            if (signal == 0) // 如果心跳信号输入为0电平
C51 COMPILER V9.60.7.0   MAIN                                                              04/03/2024 09:12:30 PAGE 5   

 229   3            {
 230   4              heartrate++; // 心率值加1
 231   4              while (signal == 0)
 232   4                ; // 等待心跳信号变为1电平
 233   4            }
 234   3            if (flag == 1) // 如果时间到了
 235   3            {
 236   4              TR1 = 0;     // 关闭定时器
 237   4              ledtest = 1; // 熄灭测量指示灯
 238   4              flag = 0;    // 时间标志位清0
 239   4              break;       // 退出测量模式
 240   4            }
 241   3          }
 242   2          if (mod)
 243   2          {
 244   3            heartrate = heartrate * 12;
 245   3          }
 246   2          tell_rate();
 247   2          finish = 1; // 测量完成标志位置1
 248   2        }
 249   1      }
 250          
 251          void sound_reset(void)
 252          {
 253   1        SOUND_RESET = 1;
 254   1        delay1ms(2);
 255   1        SOUND_RESET = 0;
 256   1        delay1ms(2);
 257   1      }
 258          
 259          void speek(unsigned char num)
 260          {
 261   1        unsigned char i = 0;
 262   1        while (SOUND_BUSY == 0)
 263   1          ;
 264   1        sound_reset();
 265   1        if ((num >= 0) && (num <= 9))
 266   1        {
 267   2          for (i = 0; i < num + 2; i++)
 268   2          {
 269   3            SOUND_DATA = 1;
 270   3            delay1ms(1);
 271   3            SOUND_DATA = 0;
 272   3            delay1ms(1);
 273   3          }
 274   2        }
 275   1        else
 276   1        {
 277   2          for (i = 0; i < num; i++)
 278   2          {
 279   3            SOUND_DATA = 1;
 280   3            delay1ms(1);
 281   3            SOUND_DATA = 0;
 282   3            delay1ms(1);
 283   3          }
 284   2        }
 285   1      }
 286          
 287          void speekone(void)
 288          {
 289   1        while (SOUND_BUSY == 0)
 290   1          ;
C51 COMPILER V9.60.7.0   MAIN                                                              04/03/2024 09:12:30 PAGE 6   

 291   1        speek(33);
 292   1      }
 293          
 294          void display_sound(void)
 295          {
 296   1        P0 = 0x00;
 297   1        speek(26);
 298   1        speek(28);
 299   1        speek(2);
 300   1        speek(0);
 301   1        speek(2);
 302   1        speek(4);
 303   1        speek(17);
 304   1        speek(4);
 305   1        speek(18);
 306   1        speek(3);
 307   1        speek(19);
 308   1        speek(20);
 309   1        speek(3);
 310   1        speek(23);
 311   1        speek(29);
 312   1        speek(9);
 313   1        speek(14);
 314   1        speek(3);
 315   1        speek(12);
 316   1        speek(15);
 317   1        for (j = 0; j < 10; j++)
 318   1          speek(my_xuehao[j]);
 319   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    920    ----
   CONSTANT SIZE    =     35    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
